#!/bin/sh
# Pre-push hook: Run all checks before pushing to prevent CI failures
# Order: baseline integrity → Python tests → TypeScript tests

# =============================================================================
# Baseline Integrity Check (must fail fast before any test execution)
# =============================================================================
echo "[pre-push] Running baseline integrity check..."
node .github/scripts/check-baseline-integrity.js
if [ $? -ne 0 ]; then
    echo ""
    echo "[pre-push] ❌ Push blocked: Baseline integrity check failed"
    echo "[pre-push] Run 'npm run perf:update-baseline' in extension/ to update baselines properly"
    exit 1
fi
echo "[pre-push] ✅ Baseline integrity check passed"

# =============================================================================
# Python Tests
# =============================================================================
echo ""
echo "[pre-push] Running Python tests..."
python -m pytest tests/ --no-cov -q
if [ $? -ne 0 ]; then
    echo ""
    echo "[pre-push] ❌ Push blocked: Python tests failed"
    exit 1
fi
echo "[pre-push] ✅ Python tests passed"

# =============================================================================
# TypeScript Type Check (fresh, no cache - catches declaration conflicts)
# =============================================================================
echo ""
echo "[pre-push] Running TypeScript type check (fresh)..."
cd extension

# Clear tsc incremental cache for fresh check (catches declaration merging issues)
rm -f tsconfig.tsbuildinfo 2>/dev/null

npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo ""
    echo "[pre-push] ❌ Push blocked: TypeScript type check failed"
    exit 1
fi
echo "[pre-push] ✅ TypeScript type check passed"

# =============================================================================
# TypeScript Tests
# =============================================================================
echo ""
echo "[pre-push] Running extension tests..."
npm run test:ci
if [ $? -ne 0 ]; then
    echo ""
    echo "[pre-push] ❌ Push blocked: Extension tests failed"
    exit 1
fi

echo "[pre-push] ✅ All pre-push checks passed"
